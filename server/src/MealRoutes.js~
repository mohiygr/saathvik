const Meal = require('./Meal')

module.exports = function (app) {

  app.post('/meals', (req, res) => {
    if (!req.body.categories) {
      res.send({status: 'error', message: "'categories' is needed"})
    } else {
      if (req.body.categories.constructor === Array) {
        if (req.body.categories.length < 1) {
          res.send({status: 'error', message: "'categories' must be a list"})
        } else if (!req.body.cost) {
          res.send({status: 'error', message: "'cost' is needed"})
        } else if (!req.body.title) {
          res.send({status: 'error', message: "'title' is needed"})
        } else {
          // finally, success!
          new Meal({
            title: req.body.title,
            categories: req.body.categories,
            cost: req.body.cost
          }).save().then(
            (o) => { res.send({status: 'ok', created: o}) },
            (e) => { console.log("Error", e); res.send({status: 'error', message: 'could not save new dish'}) })
        }
      } else {
        res.send({status: 'error', message: "'categories' should be a non-empty list"})
      }
    }
  })


  app.get('/meals', (req, res) => {
    var query = {}
    if (req.query) {
      if (req.query.category) {
        query['category'] = req.query.category
      }
    }
    Meal.find(query)
      .exec()
      .then((dbres) => {
        res.send(dbres)
      }, (err) => {
        console.log("Error", err);
        res.send({status: 'error', message: 'error occurred fetching list of meals'})
      })
  })

}
